<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8"> 
    <!--
        VGG Image Annotator (via)
        www.robots.ox.ac.uk/~vgg/software/via/

        Copyright (c) 2016, Abhishek Dutta.
        All rights reserved.

        Redistribution and use in source and binary forms, with or without
        modification, are permitted provided that the following conditions are met:

        Redistributions of source code must retain the above copyright notice, this
        list of conditions and the following disclaimer.
        Redistributions in binary form must reproduce the above copyright notice,
        this list of conditions and the following disclaimer in the documentation
        and/or other materials provided with the distribution.
        THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
        AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
        IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
        ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
        LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
        CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
        SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
        INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
        CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
        ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
        POSSIBILITY OF SUCH DAMAGE.

      -->
    <title>VGG Face Annotator</title>
    <meta name="author" content="Abhishek Dutta">
    <meta name="description" content="VGG Face Annotator lets you mark and tag rectangular facial regions in an image. It is a fork of VGG Image Annotator (http://www.robots.ox.ac.uk/~vgg/software/via/) adapted for face annotation.">

    <!-- Google analytics : used in Seebibyte project to measure impact-->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-20555581-2', 'auto');
      ga('send', 'pageview');

    </script>
    
    
    <!-- CSS style definition -->
    <style type="text/css">     
      body {
      min-width: 800px;
      padding: 0;
      margin: 0;
      margin-bottom: 3em;
      }
      
      #wrapper {
      display: table;
      text-align: center;
      }
      
      #navbar {
      position: relative;
      top: 0;
      left: 0;
      font-family: Sans;
      display: table;
      height: 1px;
      background: #000000;
      width: 100%;
      z-index: 1;
      }
      
      #navbar ul {
      display: inline;
      font-size: medium;
      list-style-type: none;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #333;
      }

      #navbar li {
      float: left;
      }

      #navbar li a, .drop_menu_item {
      display: inline-block;
      color: white;
      text-align: center;
      padding: 1em 1.2em;
      text-decoration: none;
      }

      #navbar li a:hover, .dropdown:hover .drop_menu_item {
      background-color: #999999;
      cursor: pointer;
      }

      #navbar li.dropdown {
      display: inline-block;
      }

      #navbar .dropdown-content {
      display: none;
      position: absolute;
      background-color: #333333;
      min-width: 160px;
      border: 1px solid #ffffff;
      }

      #navbar .dropdown-content a {
      color: #ffffff;
      padding: 0.4em 0.6em;
      text-decoration: none;
      font-size: small;
      display: block;
      text-align: left;
      background-color: #333333;
      float: none;
      }

      #navbar .dropdown-content a:hover {
      background-color: #000000;
      color: #ffff00;
      }

      #navbar .dropdown:hover .dropdown-content {
      display: block;
      }

      .main {
      display: table;
      width: 100%;
      table-layout: fixed;
      }

      .box {
      display: table-cell;
      padding: 1em 0;
      vertical-align: top;
      }

      .box canvas {
      position: relative;
      }

      /* Panel in the left hand side of image canvas */
      .sidebar {
      font-family: Mono;
      font-size: small;
      padding: 1em 1em;
      vertical-align: top;
      width: 280px;
      }
      .sidebar .title {
      font-family: Sans;
      font-size: large;
      padding-top: 1em;
      padding-bottom: 0.5em;
      }
      .sidebar .info table {
      border-collapse: collapse;
      table-layout: fixed;
      }
      .sidebar .info table, td {
      border: 1px solid #cccccc;
      padding: 0 0.4em;
      line-height: 2em;
      overflow: hidden;
      text-overflow: ellipsis;
      }

      /* status message panel at bottom of page */
      #message_panel {
      position: fixed;
      left: 0;
      bottom: 0px;
      line-height: 3em;
      width: 100%;
      background-color: #333333;
      color: #ffff00;
      font-size: small;
      font-family: Mono;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      z-index: 1000;
      }
      
      #invisible_file_input {
      width: 0.1px;
      height: 0.1px;
      opacity: 0;
      overflow: hidden;
      position: absolute;
      z-index: -1;
      }

      /* panel that contains the canvas */
      #image_panel {
      display: inline-block;
      margin: auto;
      }
      
      .action_text_link {
      background-color: #aaeeff;
      color: #000000;
      }
      .action_text_link:hover {
      cursor: pointer;
      }

      .svg_button:hover {
      cursor: pointer;
      }
      .js_button {
      color: blue;
      cursor: pointer;
      }

      /* image info (on top right corner) */
      #image_info {
      display: inline;
      position: relative;
      color: yellow;
      font-family: Mono;
      font-size: small;
      top: 1em;
      left: 6em;
      }

      /* loaded image list panel that pop's up on right hand side*/
      #loaded_img_list_panel {
      height: 92%;
      width: 0;
      position: fixed;
      z-index: 1;
      top: 51px;
      right: 0;
      background-color: #e6e6e6;
      overflow: scroll;
      /*transition: 0.5s;*/
      font-family: Mono;
      font-size: small;
      padding-top: 1em;
      padding-bottom: 1em;
      padding-left: 0.4em;
      }
      #loaded_img_list_panel ul {
      float: left;
      line-height: 1.2em;
      padding-left: 0;
      list-style-type: none;
      }
      #loaded_img_list_panel li:hover {
      background-color: #cccccc;
      color: #000000;
      cursor: pointer;
      }

      /* region and file attributes input panel (spreadsheet like) */
      #attributes_input_panel {
      display: none;
      position: fixed;
      z-index: 2;
      bottom: 0;
      width: 100%;
      height: 180px;
      overflow-x: auto;
      overflow-y: auto;
      white-space: nowrap;
      background-color: #ffffff;
      border-top: 4px solid #000000;
      padding-bottom: 2em;
      }

      /* face label */
      #face_label_panel {
      display: block;
      float: left;
      }
      .face_label, .active_face_label {
      display: inline-block;
      padding: 1em 1em;
      padding-bottom: 1em;
      font-family: Sans;
      font-size: xx-small;
      text-align: center;
      }     
      .active_face_label:hover {
      background-color: #e6e6e6;
      color: #ff0000;
      cursor: pointer;
      }
      .active_face_label.selected {
      background-color: #0066ff;
      color: #ffffff;
      }
      .control_panel {
      display: block;
      float: left;
      font-size: 1em;
      height: 20px;
      padding-left: 1em;
      padding-top: 0.2em;
      }
      .control_panel, .button {
      display: inline-block;
      color: #808080;
      padding-right: 0.4em;
      }
      .control_panel, .button:hover {
      color: red;
      text-decoration: none;
      cursor: pointer;
      }
    </style>
  </head>

  <body onload="main()" onresize="update_ui_components()">
    <!-- Start: Definition SVG for icons -->
    <svg style="position: absolute; width: 0; height: 0; overflow: hidden;" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
      <defs>
        <symbol id="icon_img_list">
          <title>Show image list</title>
          <rect x="2" y="10" width="30" height="2"/>
          <rect x="2" y="20" width="30" height="2"/>
          <rect x="2" y="30" width="30" height="2"/>
        </symbol>        
      </defs>
    </svg>
    <!-- End: Define SVG for icons -->

    <div class="wrapper">
      <!-- Start: navigation bar (present on top) -->
      <div id="navbar">
        <ul> 
          <li><a onclick="show_home_panel()" title="Home">Home</a></li>
          <li class="dropdown"><a title="Image" class="drop_menu_item">Image &#9662</a>
            <div class="dropdown-content">
              <a onclick="load_images('image')" title="Load (or add) a set of images from local disk">Load or add images</a>
              <a onclick="toggle_img_list()" title="Show/hide the list of currently loaded images">Show/hide image list</a>
            </div>
          </li>
          <li class="dropdown"><a title="Annotations" class="drop_menu_item">Annotation &#9662</a>
            <div class="dropdown-content">
              <a onclick="download_all_region_data('csv')" title="Save image region annotations as a CSV(comma separated value) file">Save as CSV</a>
              <a onclick="download_all_region_data('json')" title="Save image region annotations as a JSON(Javascript Object Notation) file">Save as JSON</a>
              <a onclick="upload_region_data_file()" title="Import existing region data from CSV or JSON file">Import</a>
            </div>
          </li>
          <li><a onclick="load_images('face_label')" title="Import Face Labels">Import Face Labels</a></li>
          <li class="dropdown"><a onclick="show_about_panel()" title="Help">Help &#9662</a>
            <div class="dropdown-content">
              <a onclick="show_getting_started_panel()" title="Getting started guide">Getting started</a>
              <a onclick="show_about_panel()" title="About VGG Image Annotator (VIA)">About VIA</a>
            </div>
          </li>
        </ul>

        <div id="image_info">
          <div style="display: inline-block; fill: white; stroke: white;" ><a onclick="toggle_img_list()" title="Browse currently loaded images" class="svg_button"><svg width="18" viewBox="0 0 32 32"><use xlink:href="#icon_img_list"></use></svg></a></div>
          <span id="info_current_fileid"></span> <span id="info_current_filename"><span class="action_text_link" onclick="load_images('image')" title="load local images">[click to load images]</span></span>
        </div>

        <input type="file" id="invisible_file_input" multiple name="files[]" style="display:none" onchange="">
      </div>
      <!-- End: navigation bar (present on top) -->

      <div class="main">
        <!-- Start: information display in the left side bar -->
        <div class="box sidebar" id="info_panel">
          <div class="title">Face Labels</div>
          <span class="action_text_link" onclick="toggle_attributes_input_panel()" title="Show/Hide attributes">[click to show/hide labels]</span>
          
          <div class="title">Keyboard Shortcuts</div>
          <div class="info">
            <table>
              <tr>
                <td>n/p (&larr;/&rarr;)</td>
                <td>Next/Previous image</td>
              </tr>
              <tr>
                <td>a</td>
                <td>Show/hide attributes</td>
              </tr>
              <tr>
                <td>l</td>
                <td>Show/hide image list</td>
              </tr>
              <tr>
                <td>+/-/0</td>
                <td>Zoom in/out/reset</td>
              </tr>
              <tr>
                <td>Ctrl + o</td>
                <td>Load or add images</td>
              </tr>
              <tr>
                <td>Ctrl + f</td>
                <td>Load face labels</td>
              </tr>
              <tr>
                <td>Ctrl + s</td>
                <td>Download region data</td>
              </tr>
              <tr>
                <td>Ctrl + i</td>
                <td>Import region data</td>
              </tr>
              <tr>
                <td>Ctrl + a</td>
                <td>Select all regions</td>
              </tr>
              <tr>
                <td>Ctrl + c</td>
                <td>Copy sel. regions</td>
              </tr>           
              <tr>
                <td>Ctrl + v</td>
                <td>Paste sel. regions</td>
              </tr>
              <tr>
                <td>Esc</td>
                <td>Cancel operation</td>
              </tr>
              <tr>
                <td style="width: 6em;">Alt + d</td>
                <td>Delete image region</td>
              </tr>           
              <tr>
                <td style="width: 6em;">F1</td>
                <td>Help getting started</td>
              </tr>           
            </table>
          </div>
        </div>
        <!-- End: information display in the left side bar -->

        <!-- Start: image canvas and other information panels -->
        <div class="box" id="image_panel">
          <canvas id="image_canvas">Sorry, your browser does not support HTML5 Canvas functionality which is required for this application.</canvas>

          <div id="start_info_panel" style="width: 40em;">
            <p>Quick start guide for face annotator:</p>
            <p>
              <ol>
                <li>Import the list of representative face images using [<span class="js_button" title="Load face label images" onclick="load_images('face_label')">Import Face Labels</span>] (See <span class="js_button" title="Getting Started Guide" onclick="show_getting_started_panel()">Getting Started</span>] guide for more details)</li>
                <li><span class="js_button" title="Load images" onclick="load_images('image')">[Load the images]</span> that you wish to annotate, draw rectangular regions by clicking and dragging the mouse cursor and select a face from the list of representative faces.</li>
              </ol>
            </p>
            <div id="localStorage_recovery_msg"></div>
          </div>

          <div id="getting_started_panel" style="width: 40em;">
            <p>VGG Face Annotator lets you mark and tag rectangular facial regions in an image.</p>
            <h3>Getting started</h3>
            <ol>
              <li>Import a list of representative face images using [<span class="js_button" title="Load face label images" onclick="load_images('face_label')">Import Face Labels</span>].
                <ul>
                  <li>Representative images correspond to facial image of individuals that you wish to locate and  annotate in several images.</li>
                  <li>Select all the image files that correspond to face labels (less than 512 KB)</li>
                  <li>If filename format is <span style="font-family: Mono;">1_Firstname_Lastname.jpg</span>, then 1 denotes the face label's display order and "Firstname Lastname" is the face region label.</li>
                  <li>For any other filename format, the display order is automatically determined and the full filename (excluding extension) is used as face region label.
                </ul>
                </li>
              <li>Now [<span class="js_button" title="Load images" onclick="load_images('image')">load the images</span>] that you wish to tag with rectangular facial regions.</li>
              <li>Press the key <b>n</b> (or <b>p</b>) to move to next (or previous image) and <b>l</b> to show the list of all images.</li>
              <li>Click mouse right button and drag to draw a rectangular region around a face in the loaded image. This newly created region is automatically selected. If you have more facial regions, you can continue to draw them.</li>
              <li>Press <b>a</b> key to show the face labels panel (if it is hidden). Click on one of the representative images to tag this region. The selection automatically moves to next untagged region (if any).</li>
              <li>Clicking on a region selects it allowing you to move, resize or delete them as needed.</li>
              <li>Remember to regularly save your work by clicking [Annotation &rarr; Save as CSV].</li>
              <li>Next time, to start from where you left, click [Annotation &rarr; Import] and point it to the CSV file saved in Step 7.</li>
            </ol>
          </div>
          
          <div id="img_list_panel"></div>

          <div class="" id="about_panel" style="width: 40em;">
            <p>VGG Face Annotator (VFA) lets you mark and tag rectangular facial regions in an image. Such tagged image regions are useful for supervised training of learning algorithms.</p>
            <p>VFA is a fork of <a href="http://www.robots.ox.ac.uk/~vgg/software/via/">VGG Image Annotator (VIA)</a> adapted for face annotation. VIA is an <a href="https://gitlab.com/vgg/via/">open source project</a> developed and maintained at the <a href="http://www.robots.ox.ac.uk/~vgg/">Visual Geometry Group</a> and released under the BSD-2 clause <a href="https://gitlab.com/vgg/via/blob/master/LICENSE">license</a>.</p>
            <p>
              Features:
            <ul>
              <li>based solely on HTML, CSS and Javascript (no dependecies on any javascript libraries)</li>
              <li>can be used offline (complete application packaged in a single html file of size &lt; 200KB)</li>
              <li>requires nothing more than a modern web browser (tested on firefox and chrome)</li>
              <li>import (and export) of region data from (to) text file in csv and json format</li>
              <li>hundreds of images can be loaded and annotated without any performance degradation</li>
            </ul>
            </p>
            <p>For more details, visit <a href="www.robots.ox.ac.uk/~vgg/software/via/">www.robots.ox.ac.uk/~vgg/software/via/</a></p>
          </div>
          
        </div>
        <!-- End: image canvas and other information panels -->

        <!-- A panel that pop's up on right hand side and shows the list
             of currently loaded image
          -->
        <div id="loaded_img_list_panel"></div>
      </div> <!-- end of main -->
    </div> <!-- end of wrapper -->

    <!-- A panel that pop's up at the bottom to show status messages -->
    <div id="message_panel"></div>

    <!-- A panel containing list of face labels -->
    <div id="attributes_input_panel">
      <div class="control_panel">
        <span class="button" onclick="increase_face_label_height()">&plus;</span>
        <span class="button" onclick="decrease_face_label_height()">&minus;</span>
        <span class="button" onclick="toggle_attributes_input_panel()">&times;</span>
      </div>
      <div id="face_label_panel"></div>
    </div>
    
    <!--<script type="text/javascript" src="via_face_demo_sherlock.js">-->
    <script type="text/javascript">
      <!--AUTO_INSERT_VIA_DEMO_JS_HERE-->
    </script>
    <!--<script type="text/javascript" src="via_face.js">-->
    <script type="text/javascript">
      <!--AUTO_INSERT_VIA_JS_HERE-->
/*
  VGG Image Annotator (via)
  www.robots.ox.ac.uk/~vgg/software/via/
  
  Copyright (c) 2016, Abhishek Dutta.
  All rights reserved.

  Redistribution and use in source and binary forms, with or without
  modification, are permitted provided that the following conditions are met:

  Redistributions of source code must retain the above copyright notice, this
  list of conditions and the following disclaimer.
  Redistributions in binary form must reproduce the above copyright notice,
  this list of conditions and the following disclaimer in the documentation
  and/or other materials provided with the distribution.
  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
  POSSIBILITY OF SUCH DAMAGE.
*/

var VIA_VERSION = '0.1';
var VIA_NAME = 'VGG Face Annotator';
var VIA_SHORT_NAME = 'VFA';
var VIA_REGION_SHAPE = { RECT:'rect'};

var VIA_SPECIAL_CHAR_SUBS = {',':'[comma]',
                             ':':'[colon]',
                             ';':'[scolon]',
                             '=':'[equal]'};
var VIA_REGION_EDGE_TOL = 5;
var VIA_REGION_MIN_DIM = 5;
var VIA_CANVAS_ZOOM_LEVELS = [0.25, 0.5, 0.75, 1.0, 2.0, 3.0, 4.0];
var VIA_CANVAS_DEFAULT_ZOOM_LEVEL_INDEX = 3;
var VIA_FACE_LABEL_ATTR_NAME = 'face_label';
var VIA_FACE_LABEL_MAX_SIZE_KB = 512;
var VIA_MAX_CSV_DOWNLOAD_SIZE_MB = 2;

var VIA_THEME_REGION_BOUNDARY_WIDTH = 4;
var VIA_THEME_BOUNDARY_LINE_COLOR = "#1a1a1a";
var VIA_THEME_BOUNDARY_FILL_COLOR = "#aaeeff";
var VIA_THEME_SEL_REGION_FILL_COLOR = "#808080";
var VIA_THEME_SEL_REGION_FILL_BOUNDARY_COLOR = "#000000";
var VIA_THEME_SEL_REGION_OPACITY = 0.5;
var VIA_THEME_MESSAGE_TIMEOUT_MS = 3000;
var VIA_IMPORT_CSV_COMMENT_CHAR = '#';
var VIA_IMPORT_CSV_KEYVAL_SEP_CHAR = ';';
var VIA_EXPORT_CSV_ARRAY_SEP_CHAR = ':';
var VIA_CSV_SEP_CHAR = ',';

var _via_images = {};          // stores image ref and annotation data for all loaded image
var _via_images_count = 0;
var _via_canvas_regions = [];  // image regions spec. in canvas space
var _via_canvas_scale = 1.0;   // current scale of canvas image

var _via_image_id_list = [];   // array of image id (in original order)
var _via_image_id = '';        // id={filename+length} of current image
var _via_image_index = -1;     // array-index of current image

var _via_current_image_filename;
var _via_current_image;

// image canvas
var _via_canvas = document.getElementById("image_canvas");
var _via_ctx = _via_canvas.getContext("2d");
var _via_canvas_width, _via_canvas_height;

// canvas zoom
var _via_canvas_zoom_level_index = VIA_CANVAS_DEFAULT_ZOOM_LEVEL_INDEX; // 1.0
var _via_canvas_scale_without_zoom = 1.0;

// state of the application
var _via_is_user_drawing_region = false;
var _via_current_image_loaded = false;
var _via_is_window_resized = false;
var _via_is_user_resizing_region = false;
var _via_is_user_moving_region = false;
var _via_is_region_selected = false;
var _via_is_all_region_selected = false;
var _via_is_loaded_img_list_visible = false;
var _via_is_attributes_input_panel_visible = false;
var _via_is_canvas_zoomed = false;
var _via_is_loading_current_image = false;

// region
var _via_current_shape = VIA_REGION_SHAPE.RECT;
var _via_user_sel_region_id = -1;
var _via_click_x0 = 0; var _via_click_y0 = 0;
var _via_click_x1 = 0; var _via_click_y1 = 0;
var _via_region_edge = [-1, -1];
var _via_region_click_x, _via_region_click_y;
var _via_copied_image_regions = [];
var _via_copied_canvas_regions = [];

// message
var _via_message_clear_timer;

// attributes
var _via_region_attributes = new Set();
var _via_face_label_list = [];
var _via_face_label_img_list = [];

// persistence to local storage
var _via_is_local_storage_available = false;
var _via_is_save_ongoing = false;

// image list
var _via_reload_img_table = true;
var _via_loaded_img_fn_list = [];
var _via_loaded_img_region_attr_miss_count = [];
var _via_loaded_img_table_html = [];

// face label
var _via_face_label_height_list = [80, 100, 120, 140, 160, 180, 200, 260, 300, 360];
var VIA_FACE_LABEL_DEFAULT_HEIGHT_ID = 4;
var _via_face_label_height_id = 4;

// UI html elements
var invisible_file_input = document.getElementById("invisible_file_input");

var image_panel = document.getElementById("image_panel");
var navbar_panel = document.getElementById("navbar");

var loaded_img_list_panel = document.getElementById('loaded_img_list_panel');
var attributes_input_panel = document.getElementById('attributes_input_panel');
var face_label_panel = document.getElementById('face_label_panel');

function main() {
    show_message(VIA_NAME + ' (' + VIA_SHORT_NAME + ') ' +
                 'version ' + VIA_VERSION,
                 2*VIA_THEME_MESSAGE_TIMEOUT_MS);
    show_home_panel();
    //start_demo_session(); // defined in via_demo.js
    
    _via_is_local_storage_available = check_local_storage();
    if (_via_is_local_storage_available) {
        if (is_via_data_in_localStorage()) {
            show_localStorage_recovery_options();
        }
    }
    _via_region_attributes.add(VIA_FACE_LABEL_ATTR_NAME);
    //show_attributes_input_panel();
}

//
// Data structures to hold image and annotation data
//
function ImageAttributes(fileref, filename, size) {
    this.filename = filename;
    this.size = size;
    this.fileref = fileref;
    this.file_attributes = new Map(); // image attributes
    this.base64_img_data = '';       // image data stored as base 64
    this.regions = [];
}

function ImageRegion() {
    this.is_user_selected = false;
    this.shape_attributes = new Map();  // region shape attributes
    this.region_attributes = new Map(); // region attributes
}

function clone_image_region(r0) {
    var r1 = new ImageRegion();
    r1.is_user_selected = r0.is_user_selected;

    // copy shape attributes
    for ( var key of r0.shape_attributes.keys() ) {
        var value = r0.shape_attributes.get(key);
        r1.shape_attributes.set(key, value);
    }
    
    // copy region attributes
    for ( var key of r0.region_attributes.keys() ) {
        var value = r0.region_attributes.get(key);
        r1.region_attributes.set(key, value);
    }
    return r1;
}

// create a unique file identifier
function _via_get_image_id(filename, size) {
    return filename + size;
}

//
// Handlers for top navigation bar
//
function load_images(type) {
    // source: https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications
    if (invisible_file_input) {
        invisible_file_input.accept='.jpg,.jpeg,.png,.bmp';
        switch(type) {
        case 'image':
            invisible_file_input.onchange = store_ref_to_local_images;
            invisible_file_input.click();
            break;
        case 'face_label':
            invisible_file_input.onchange = load_face_label_images;
            invisible_file_input.click();
            break;
        }       
    }
}

function download_all_region_data(type) {
    var d = package_region_data(type);
    var dblob = new Blob( d,
                          {type: 'text/'+type+';charset=utf-8'});
    var size = dblob.size/(1024*1024);

    if ( type == 'csv' &&
         size > VIA_MAX_CSV_DOWNLOAD_SIZE_MB) {
        show_message('CSV file size is ' + size + ' MB. We advise you to instead download as JSON');
    } else {
        save_data_to_local_file(dblob, 'via_region_data.'+type);
    }
}

function upload_region_data_file() {
    if (invisible_file_input) {
        invisible_file_input.accept='.csv,.json';
        invisible_file_input.onchange = import_region_data_from_file;
        invisible_file_input.click();
    }

}

function show_home_panel() {
    clear_image_display_area();
    if (_via_current_image_loaded) {
        _via_canvas.style.display = "block";    
    } else {
        document.getElementById('start_info_panel').style.display = "block";
    }
}

function show_about_panel() {
    clear_image_display_area();
    document.getElementById('about_panel').style.display = "block";
}

function show_getting_started_panel() {
    clear_image_display_area();
    document.getElementById('getting_started_panel').style.display = "block";
}

//
// Local file uploaders
//
function store_ref_to_local_images(event) {
    var user_selected_images = event.target.files;
    var original_image_count = _via_images_count;

    // clear browser cache if user chooses to load new images
    if (original_image_count == 0) {
        localStorage.clear();
    }

    var discarded_file_count = 0;
    for ( var i=0; i<user_selected_images.length; ++i) {
        if (user_selected_images[i].type.includes('image/')) {
            var filename = user_selected_images[i].name;
            var size = user_selected_images[i].size;
            var img_id = _via_get_image_id(filename, size);

            if (_via_images.hasOwnProperty(img_id)) {
                if (_via_images[img_id].fileref) {
                    show_message('Image ' + filename + ' already loaded. Skipping!');
                } else {
                    _via_images[img_id].fileref = user_selected_images[i];
                    show_message('Regions already exist for file ' + filename + ' !');
                }
            } else {
                _via_images[img_id] = new ImageAttributes(user_selected_images[i],
                                                          filename,
                                                          size);
                _via_image_id_list.push(img_id);
                _via_images_count += 1;
                _via_reload_img_table = true;
            }
        } else {
            discarded_file_count += 1;
        }
    }

    if ( _via_images ) {
        var status_msg = 'Loaded ' + (_via_images_count - original_image_count) + ' images.';
        if (discarded_file_count) {
            status_msg += ' ( Discarded ' + discarded_file_count + ' non-image files! )';
        }
        show_message( status_msg);
        
        if (_via_image_index == -1) {
            show_image(0);
        } else {
            show_image( original_image_count );
        }
    } else {
        show_message("Please upload some image files!");
    }
}

function load_face_label_images(event) {
    var selected_files = event.target.files;
    for (var i=0; i<selected_files.length; ++i) {
        var file = selected_files[i];
        var size = file.size/1024;
        
        if (file.type.includes('image/') &&
            size < VIA_FACE_LABEL_MAX_SIZE_KB) {
            set_face_label_image(file, update_attributes_input_panel);
        } else {
            show_message('Discarded face label images  > ' +
                         VIA_FACE_LABEL_MAX_SIZE_KB + 'KB');
        }
    }
    show_attributes_input_panel();
}

function set_face_label_image(file, callback_function) {
    var filename = file.name.split('.');
    var filename = filename[0]; // remove extension

    var label = '';
    var file_id = -1;
    
    if (filename.includes('_')) {
        // filename named according to convention
        var filename_split = filename.split('_');
        var file_id = parseInt(filename_split[0]);
        filename_split.splice(0, 1); // remove file id
        label = filename_split.join('_');

        if (isNaN(file_id)) {
            file_id = _via_face_label_list.push(label);
            file_id -= 1; // push() returns length, 0 based index
        } else {
            _via_face_label_list[file_id] = label;
        }
    } else {
        label = filename;
        file_id = _via_face_label_list.push(label);
        file_id -= 1; // push() returns length, 0 based index
    }
    
    var img_reader = new FileReader();    
    img_reader.addEventListener( "load", function() {
        _via_face_label_img_list[file_id] = img_reader.result;
        callback_function();
    });
    img_reader.readAsDataURL( file );
}

//
// Data Importer
//

function import_region_attributes_from_file(event) {
    var selected_files = event.target.files;
    for (var i=0; i<selected_files.length; ++i) {
        var file = selected_files[i];
        switch(file.type) {
        case 'text/csv':
            load_text_file(file, import_region_attributes_from_csv);
            break;
        }
    }
}

function import_region_attributes_from_csv(data) {
    data = data.replace(/\n/g, ''); // discard newline \n
    var csvdata = data.split(',');
    var attributes_import_count = 0;
    for (var i=0; i<csvdata.length; ++i) {
        if ( !_via_region_attributes.has(csvdata[i]) ) {
            _via_region_attributes.add(csvdata[i]);
            attributes_import_count += 1;
        }
    }

    _via_reload_img_table = true;
    show_message('Imported ' + attributes_import_count + ' attributes from CSV file');
    save_current_data_to_browser_cache();
}

function import_region_data_from_file(event) {
    var selected_files = event.target.files;
    for (var file of selected_files) {
        switch(file.type) {
        case 'text/plain':
        case 'text/csv':
            load_text_file(file, import_region_data_from_csv);
            break;
        case 'text/json':
        case 'application/json':
            load_text_file(file, import_region_data_from_json);
            break;
        }
    }
}

function import_region_data_from_csv(data) {
    var csvdata = data.split('\n');
    var region_import_count = 0;
    var file_attr_count = 0;
    var image_count = 0;
    for (var i=0; i<csvdata.length; ++i) {
        if (csvdata[i].charAt(0) == VIA_IMPORT_CSV_COMMENT_CHAR) {
            // ignore header
            // #filename,file_size,face_count,face_id,x,y,width,height,face_label
            continue;
        } else {
            var d = csvdata[i].split(',');
            if (d.length != 9) {
                // ignore row
                continue;
            }
            
            var filename = d[0];
            var size = d[1];
            var image_id = _via_get_image_id(filename, size);
            if ( _via_images.hasOwnProperty(image_id) ) {
                image_count += 1;
                
                var regioni = new ImageRegion();
                regioni.shape_attributes.set('x', d[4]);
                regioni.shape_attributes.set('y', d[5]);
                regioni.shape_attributes.set('width', d[6]);
                regioni.shape_attributes.set('height', d[7]);

                var rattr = d[8].replace(/"/g, '');
                regioni.region_attributes.set(VIA_FACE_LABEL_ATTR_NAME, rattr);
             
                _via_images[image_id].regions.push(regioni);
                region_import_count += 1;
            }
        }
    }
    show_message('Imported [' + region_import_count + '] regions ' +
                 ' and [' + file_attr_count + '] file attributes for ' +
                 image_count + ' images from CSV file');

    _via_reload_img_table = true;
    show_image(_via_image_index);
    save_current_data_to_browser_cache();
}

function import_region_data_from_json(data) {
    var d = JSON.parse(data);

    var image_count = 0;
    var region_import_count = 0;
    var file_attr_count = 0;
    var skipped_file_attr_count = 0;
    for (image_id in d) {
        if ( _via_images.hasOwnProperty(image_id) ) {
            image_count += 1;
            
            // copy regions
            var regions = d[image_id].regions;
            for (var i in regions) {
                var regioni = new ImageRegion();
                for (var key in regions[i].shape_attributes) {
                    regioni.shape_attributes.set(key, regions[i].shape_attributes[key]);
                }
                for (var key in regions[i].region_attributes) {
                    regioni.region_attributes.set(key, regions[i].region_attributes[key]);

                    if (!_via_region_attributes.has(key)) {
                        _via_region_attributes.add(key);
                    }
                }

                // add regions only if they are present
                if (regioni.shape_attributes.size > 0 ||
                    regioni.region_attributes.size > 0 ) {
                    _via_images[image_id].regions.push(regioni);
                    region_import_count += 1;
                }
            }
        }
    }

    show_message('Imported [' + region_import_count + '] regions' +
                 ' and [' + file_attr_count + '] file attributes for ' +
                 image_count + ' images from JSON file');
    
    _via_reload_img_table = true;
    show_image(_via_image_index);
}

// key1=val1;key2=val2;...
function keyval_str_to_map(keyval_str) {
    var keyval_map = new Map();
    var d = keyval_str.split(VIA_IMPORT_CSV_KEYVAL_SEP_CHAR);    
    for (var i=0; i<d.length; ++i) {
        var keyval = d[i].split('=');
        if ( keyval.length == 2 ) {
            keyval_map.set(keyval[0], keyval[1]);
        } else {
            show_message('Skipping malformed values in the imported file');
        }
    }
    return keyval_map;
}

function load_text_file(text_file, callback_function) {
    if (!text_file) {
        return;
    } else {
        text_reader = new FileReader();
        text_reader.addEventListener( "progress", function(e) {
            show_message("Loading data from text file : " + text_file.name + " ... ");
        }, false);

        text_reader.addEventListener( "error", function() {
            show_message("Error loading data from text file :  " + text_file.name + " !");
            callback_function('');
        }, false);
        
        text_reader.addEventListener( "load", function() {
            callback_function(text_reader.result);
        }, false);
        text_reader.readAsText(text_file);
    }
}

//
// Data Exporter
//
function package_region_data(return_type) {
    if( return_type == "csv" ) {
        var csvdata = [];
        var csvheader = '#filename,file_size,face_count,face_id,x,y,width,height,';
        csvheader += VIA_FACE_LABEL_ATTR_NAME;
        csvdata.push(csvheader);

        for ( var image_id in _via_images ) {
            var prefix = _via_images[image_id].filename;
            prefix += "," + _via_images[image_id].size;

            var regions = _via_images[image_id].regions;

            if (regions.length !=0) {
                for (var i=0; i<regions.length; ++i) {
                    var sdata = regions.length + ',' + i + ',';
                    sdata += regions[i].shape_attributes.get('x') + ',';
                    sdata += regions[i].shape_attributes.get('y') + ',';
                    sdata += regions[i].shape_attributes.get('width') + ',';
                    sdata += regions[i].shape_attributes.get('height');

                    var rdata = regions[i].region_attributes.get(VIA_FACE_LABEL_ATTR_NAME);
                    
                    csvdata.push('\n' + prefix + ',' + sdata + ',' + '"' + rdata + '"');
                }
            }
        }
        return csvdata;
    } else {
        // JSON.stringify() does not work with Map()
        // hence, we cast everything as objects
        var _via_images_as_obj = {};
        for (image_id in _via_images) {
            var image_data = {};
            image_data.size = _via_images[image_id].size;
            image_data.filename = _via_images[image_id].filename;
            
            // copy all region shape_attributes
            image_data.regions = {};
            for (var i=0; i<_via_images[image_id].regions.length; ++i) {
                image_data.regions[i] = {};
                image_data.regions[i].shape_attributes = {};
                image_data.regions[i].region_attributes = {};
                // copy region shape_attributes
                for ( var key of _via_images[image_id].regions[i].shape_attributes.keys()) {
                    var value = _via_images[image_id].regions[i].shape_attributes.get(key);
                    image_data.regions[i].shape_attributes[key] = value;
                }
                // copy region_attributes
                for ( var key of _via_images[image_id].regions[i].region_attributes.keys()) {
                    var value = _via_images[image_id].regions[i].region_attributes.get(key);
                    image_data.regions[i].region_attributes[key] = value;
                }
            }           
            _via_images_as_obj[image_id] = image_data;
        }
        return [JSON.stringify(_via_images_as_obj)];
    }    
}

function attr_map_to_str(attr) {
    var attr_map_str = [];
    for( var key of attr.keys() ) {
        var value = attr.get(key);
        if ( Array.isArray(value) ) {
            var value_str='[' + value[0];
            for (var i=1; i<value.length; ++i) {
                value_str += VIA_EXPORT_CSV_ARRAY_SEP_CHAR + value[i];
            }
            value_str += ']';
            attr_map_str.push(key + '=' + value_str);
        } else {
            value = remove_special_chars(value);
            attr_map_str.push(key + '=' + value);
        }
    }
    var str_val = '"' + attr_map_str.join(VIA_IMPORT_CSV_KEYVAL_SEP_CHAR) + '"';
    return str_val;
}

function remove_special_chars(str) {
    var s = String(str);
    for (var key in VIA_SPECIAL_CHAR_SUBS) {
        s = s.replace(new RegExp(key, 'g'),
                      VIA_SPECIAL_CHAR_SUBS[key]);
    }
    return s;
}

function substitute_special_chars(str) {
    var s = String(str);
    for (var key in VIA_SPECIAL_CHAR_SUBS) {
        var value = VIA_SPECIAL_CHAR_SUBS[key];
        s = s.replace(new RegExp(value, 'g'),
                      key);
    }
    return s;
}

function save_data_to_local_file(data, filename) {
    var a = document.createElement('a');
    a.href = URL.createObjectURL(data);
    a.target = '_blank';
    a.download = filename;

    // simulate a mouse click event
    var event = new MouseEvent('click', {
        view: window,
        bubbles: true,
        cancelable: true
    });
    
    a.dispatchEvent(event);
}

//
// Setup Elements in User Interface
//
function show_image(image_index) {
    if (_via_is_loading_current_image) {
        return;
    }
    
    var img_id = _via_image_id_list[image_index]
    if (_via_images.hasOwnProperty(img_id)) {
        var img_filename = _via_images[img_id].filename;
        var img_reader = new FileReader();
        _via_is_loading_current_image = true;

        img_reader.addEventListener( "loadstart", function(e) {
            document.getElementById("info_current_filename").innerHTML = "Loading image ...";
        }, false);
        
        img_reader.addEventListener( "progress", function(e) {
            //show_message("Loading image " + img_filename + " ... ", 1000);
        }, false);

        img_reader.addEventListener( "error", function() {
            show_message("Error loading image " + img_filename + " !");
        }, false);
        
        img_reader.addEventListener( "load", function() {
            _via_current_image = new Image();
            _via_current_image.addEventListener( "load", function() {
                _via_image_id = img_id;
                _via_image_index = image_index;
                _via_current_image_filename = img_filename;

                _via_click_x0 = 0; _via_click_y0 = 0;
                _via_click_x1 = 0; _via_click_y1 = 0;
                _via_is_user_drawing_region = false;
                _via_is_window_resized = false;         
                _via_is_user_resizing_region = false;
                _via_is_user_moving_region = false;
                _via_is_all_region_selected = false;
                _via_is_canvas_zoomed = false;
                _via_is_region_selected = false;
                _via_user_sel_region_id = -1;
                _via_canvas.style.cursor = "default";
                
                _via_current_image_loaded = true;
                _via_is_loading_current_image = false;
                
                // retrive image panel dim. to stretch _via_canvas to fit panel
                canvas_panel_width = document.documentElement.clientWidth - 320;
                canvas_panel_height = document.documentElement.clientHeight - 2.2*navbar_panel.offsetHeight;
                
                _via_canvas_width = _via_current_image.naturalWidth;
                _via_canvas_height = _via_current_image.naturalHeight;

                var scale_width, scale_height;
                if ( _via_canvas_width > canvas_panel_width ) {
                    // resize image to match the panel width
                    var scale_width = canvas_panel_width / _via_current_image.naturalWidth;
                    _via_canvas_width = canvas_panel_width;
                    _via_canvas_height = _via_current_image.naturalHeight * scale_width;
                }
                // resize image if its height is larger than the image panel
                if ( _via_canvas_height > canvas_panel_height ) {
                    var scale_height = canvas_panel_height / _via_canvas_height;
                    _via_canvas_height = canvas_panel_height;
                    _via_canvas_width = _via_canvas_width * scale_height;
                }

                _via_canvas_width = Math.round(_via_canvas_width);
                _via_canvas_height = Math.round(_via_canvas_height);
                _via_canvas_scale = _via_current_image.naturalWidth / _via_canvas_width;
                _via_canvas_scale_without_zoom = _via_canvas_scale;
                
                // set the canvas size to match that of the image
                _via_canvas.height = _via_canvas_height;
                _via_canvas.width = _via_canvas_width;
                
                clear_image_display_area();
                _via_canvas.style.display = "inline";

                // refresh the image list
                _via_reload_img_table = true;
                if (_via_is_loaded_img_list_visible) {
                    show_img_list();
                }

                // refresh the attributes panel
                update_attributes_input_panel();

                _via_load_canvas_regions(); // image to canvas space transform
                _via_redraw_canvas();
                _via_canvas.focus();

                // update the info panel
                show_filename_info();
            });
            _via_current_image.src = img_reader.result;
        }, false);
        
        if (_via_images[img_id].base64_img_data == '') {
            // load image from file
            img_reader.readAsDataURL( _via_images[img_id].fileref );
        } else {
            // load image from bae64 data
            img_reader.readAsText( new Blob([_via_images[img_id].base64_img_data]) );
        }
    }
}

// transform regions in image space to canvas space
function _via_load_canvas_regions() {
    // load all existing annotations into _via_canvas_regions
    var regions = _via_images[_via_image_id].regions;
    _via_canvas_regions  = [];
    for ( var i=0; i<regions.length; ++i) {
        var regioni = new ImageRegion();
        for ( var key of regions[i].shape_attributes.keys() ) {
            var value = regions[i].shape_attributes.get(key);
            regioni.shape_attributes.set(key, value);
        }
        _via_canvas_regions.push(regioni);

        var x = regions[i].shape_attributes.get('x') / _via_canvas_scale;
        var y = regions[i].shape_attributes.get('y') / _via_canvas_scale;
        var width = regions[i].shape_attributes.get('width') / _via_canvas_scale;
        var height = regions[i].shape_attributes.get('height') / _via_canvas_scale;
        
        _via_canvas_regions[i].shape_attributes.set('x', Math.round(x));
        _via_canvas_regions[i].shape_attributes.set('y', Math.round(y));
        _via_canvas_regions[i].shape_attributes.set('width', Math.round(width));
        _via_canvas_regions[i].shape_attributes.set('height', Math.round(height));
    }
}

function clear_image_display_area() {
    _via_canvas.style.display = "none";
    document.getElementById('about_panel').style.display = 'none';
    document.getElementById('start_info_panel').style.display = 'none';
    document.getElementById('getting_started_panel').style.display = 'none';
}

function delete_selected_regions() {
    var del_region_count = 0;
    if (_via_is_all_region_selected) {
        del_region_count = _via_canvas_regions.length;  
        _via_canvas_regions.splice(0);
        _via_images[_via_image_id].regions.splice(0);
    } else {
        var sorted_sel_reg_id = [];
        for (var i=0; i<_via_canvas_regions.length; ++i) {
            if (_via_canvas_regions[i].is_user_selected) {
                sorted_sel_reg_id.push(i);
            }
        }       
        sorted_sel_reg_id.sort( function(a,b) {
            return (b-a);
        });
        for (var i=0; i<sorted_sel_reg_id.length; ++i) {
            _via_canvas_regions.splice( sorted_sel_reg_id[i], 1);
            _via_images[_via_image_id].regions.splice( sorted_sel_reg_id[i], 1);
            del_region_count += 1;
        }
    }

    _via_is_all_region_selected = false;
    _via_is_region_selected = false;
    _via_user_sel_region_id = -1;   
    _via_redraw_canvas();
    _via_canvas.focus();
    show_message('Deleted ' + del_region_count + ' selected regions');
    save_current_data_to_browser_cache();
}

//
// UI Control Elements (buttons, etc)
//

// enter annotation mode on double click
_via_canvas.addEventListener('dblclick', function(e) {
    show_message('Double clicks are not used in this application');
}, false);

// user clicks on the canvas
_via_canvas.addEventListener('mousedown', function(e) {
    _via_click_x0 = e.offsetX; _via_click_y0 = e.offsetY;
    _via_region_edge = is_on_region_corner(_via_click_x0, _via_click_y0);
    var region_id = is_inside_region(_via_click_x0, _via_click_y0);
    
    if ( _via_is_region_selected ) {
        // check if user clicked on the region boundary
        if ( _via_region_edge[1] > 0 ) {
            if ( !_via_is_user_resizing_region ) {
                // resize region
                if ( _via_region_edge[0] != _via_user_sel_region_id ) {
                    _via_user_sel_region_id = _via_region_edge[0];
                }
                _via_is_user_resizing_region = true;
            }
        } else {
            // check if user clicked inside a region
            if ( region_id == _via_user_sel_region_id ) {
                if( !_via_is_user_moving_region ) {     
                    _via_is_user_moving_region = true;
                    _via_region_click_x = _via_click_x0;
                    _via_region_click_y = _via_click_y0;
                }
            } else {
                if ( region_id == -1 ) {
                    // mousedown on outside any region
                    _via_is_user_drawing_region = true;
                    // unselect all regions
                    _via_is_region_selected = false;
                    _via_user_sel_region_id = -1;
                    toggle_all_regions_selection(false);
                }
            }
        }
    } else {
        if ( region_id == -1 ) {
            // this is a bounding box drawing event
            _via_is_user_drawing_region = true;
        }
    }
    e.preventDefault();
}, false);

// implements the following functionalities:
//  - new region drawing
//  - moving/resizing/select/unselect existing region
_via_canvas.addEventListener('mouseup', function(e) {
    _via_click_x1 = e.offsetX; _via_click_y1 = e.offsetY;

    var click_dx = Math.abs(_via_click_x1 - _via_click_x0);
    var click_dy = Math.abs(_via_click_y1 - _via_click_y0);

    // indicates that user has finished moving a region
    if ( _via_is_user_moving_region ) {
        _via_is_user_moving_region = false;
        _via_canvas.style.cursor = "default";

        var move_x = Math.round(_via_click_x1 - _via_region_click_x);
        var move_y = Math.round(_via_click_y1 - _via_region_click_y);

        // @todo: update the region data
        var image_attr = _via_images[_via_image_id].regions[_via_user_sel_region_id].shape_attributes;
        var canvas_attr = _via_canvas_regions[_via_user_sel_region_id].shape_attributes;
        
        var xnew = image_attr.get('x') + Math.round(move_x * _via_canvas_scale);
        var ynew = image_attr.get('y') + Math.round(move_y * _via_canvas_scale);
        image_attr.set('x', xnew);
        image_attr.set('y', ynew);

        var canvas_xnew = canvas_attr.get('x') + move_x;
        var canvas_ynew = canvas_attr.get('y') + move_y;
        canvas_attr.set('x', canvas_xnew);
        canvas_attr.set('y', canvas_ynew);
        
        _via_redraw_canvas();
        _via_canvas.focus();
        save_current_data_to_browser_cache();
        return;
    }

    // indicates that user has finished resizing a region
    if ( _via_is_user_resizing_region ) {
        // _via_click(x0,y0) to _via_click(x1,y1)
        _via_is_user_resizing_region = false;
        _via_canvas.style.cursor = "default";
        
        // update the region
        var region_id = _via_region_edge[0];
        var image_attr = _via_images[_via_image_id].regions[region_id].shape_attributes;
        var canvas_attr = _via_canvas_regions[region_id].shape_attributes;
        
        var x0 = canvas_attr.get('x');
        var y0 = canvas_attr.get('y');
        var x1 = x0 + canvas_attr.get('width');
        var y1 = y0 + canvas_attr.get('height');

        switch(_via_region_edge[1]) {
        case 1: // top-left
            x0 = _via_current_x;
            y0 = _via_current_y;
            break;
        case 3: // bottom-right
            x1 = _via_current_x;
            y1 = _via_current_y;
            break;
        case 2: // top-right
            x1 = _via_current_x;
            y0 = _via_current_y;
            break;
        case 4: // bottom-left
            x0 = _via_current_x;
            y1 = _via_current_y;
            break;
        }
        var w = Math.abs(x1-x0);
        var h = Math.abs(y1-y0);
        image_attr.set('x', Math.round(x0 * _via_canvas_scale));
        image_attr.set('y', Math.round(y0 * _via_canvas_scale));
        image_attr.set('width', Math.round(w * _via_canvas_scale));
        image_attr.set('height', Math.round(h * _via_canvas_scale));

        canvas_attr.set('x', x0);
        canvas_attr.set('y', y0);
        canvas_attr.set('width', w);
        canvas_attr.set('height', h);

        _via_redraw_canvas();
        _via_canvas.focus();
        save_current_data_to_browser_cache();
        return;
    }
    
    // denotes a single click (= mouse down + mouse up)
    if ( click_dx < 5 ||
         click_dy < 5 ) {
        var region_id = is_inside_region(_via_click_x0, _via_click_y0);
        if ( region_id >= 0 ) {
            // first click selects region
            _via_user_sel_region_id = region_id;
            _via_is_region_selected = true;
            _via_is_user_moving_region = false;
            
            // de-select all other regions if the user has not pressed Shift
            if ( !e.shiftKey ) {
                toggle_all_regions_selection(false);
            }
            _via_canvas_regions[region_id].is_user_selected = true;
        } else {
            if ( _via_is_user_drawing_region ) {
                // clear all region selection
                _via_is_user_drawing_region = false;
                toggle_all_regions_selection(false);
            }
        }
        _via_redraw_canvas();
        _via_canvas.focus();
        update_attributes_input_panel();
        return;
    }

    // indicates that user has finished drawing a new region
    if (_via_is_user_drawing_region) {
        
        _via_is_user_drawing_region = false;
        
        var region_x0, region_y0, region_x1, region_y1;
        // ensure that (x0,y0) is top-left and (x1,y1) is bottom-right
        if ( _via_click_x0 < _via_click_x1 ) {
            region_x0 = _via_click_x0;
            region_x1 = _via_click_x1;
        } else {
            region_x0 = _via_click_x1;
            region_x1 = _via_click_x0;
        }

        if ( _via_click_y0 < _via_click_y1 ) {
            region_y0 = _via_click_y0;
            region_y1 = _via_click_y1;
        } else {
            region_y0 = _via_click_y1;
            region_y1 = _via_click_y0;
        }

        var original_img_region = new ImageRegion();
        var canvas_img_region = new ImageRegion();
        var region_dx = Math.abs(region_x1 - region_x0);
        var region_dy = Math.abs(region_y1 - region_y0);

        // newly drawn region is automatically selected
        toggle_all_regions_selection(false);
        canvas_img_region.is_user_selected = true;
        _via_is_region_selected = true;
        _via_user_sel_region_id = _via_canvas_regions.length; // new region's id
        
        if ( region_dx > VIA_REGION_MIN_DIM ||
             region_dy > VIA_REGION_MIN_DIM ) { // avoid regions with 0 dim
                original_img_region.shape_attributes.set('name', 'rect');
            original_img_region.shape_attributes.set('x', Math.round(region_x0 * _via_canvas_scale));
            original_img_region.shape_attributes.set('y', Math.round(region_y0 * _via_canvas_scale));
            original_img_region.shape_attributes.set('width', Math.round(region_dx * _via_canvas_scale));
            original_img_region.shape_attributes.set('height', Math.round(region_dy * _via_canvas_scale));

            canvas_img_region.shape_attributes.set('name', 'rect');
            canvas_img_region.shape_attributes.set('x', Math.round(region_x0));
            canvas_img_region.shape_attributes.set('y', Math.round(region_y0));
            canvas_img_region.shape_attributes.set('width', Math.round(region_dx));
            canvas_img_region.shape_attributes.set('height', Math.round(region_dy));

            _via_images[_via_image_id].regions.push(original_img_region);
            _via_canvas_regions.push(canvas_img_region);
        } else {
            show_message('Skipped adding a ' + _via_current_shape + ' of nearly 0 dimension');
        }
        update_attributes_input_panel();
        _via_reload_img_table = true;
        show_img_list();

        _via_redraw_canvas();
        _via_canvas.focus();
        save_current_data_to_browser_cache();
        return;
    }    
});

function toggle_all_regions_selection(is_selected) {
    for (var i=0; i<_via_canvas_regions.length; ++i) {
        _via_canvas_regions[i].is_user_selected = is_selected;
    }
    _via_is_all_region_selected = is_selected;
}

function select_only_region(region_id) {
    toggle_all_regions_selection(false);
    _via_canvas_regions[region_id].is_user_selected = true;
    _via_user_sel_region_id = region_id;
    _via_is_region_selected = true;
}

_via_canvas.addEventListener("mouseover", function(e) {
    // change the mouse cursor icon
    _via_redraw_canvas();
    _via_canvas.focus();
});

_via_canvas.addEventListener('mousemove', function(e) {
    if ( !_via_current_image_loaded ) {
        return;
    }
    
    _via_current_x = e.offsetX; _via_current_y = e.offsetY;

    if ( _via_is_region_selected ) {
        if ( !_via_is_user_resizing_region ) {
            // check if user moved mouse cursor to region boundary
            // which indicates an intention to resize the reigon
            
            _via_region_edge = is_on_region_corner(_via_current_x, _via_current_y);

            if ( _via_region_edge[0] == _via_user_sel_region_id ) {
                switch(_via_region_edge[1]) {
                    // rect
                case 1: // top-left corner of rect
                case 3: // bottom-right corner of rect
                    _via_canvas.style.cursor = "nwse-resize";
                    break;
                case 2: // top-right corner of rect
                case 4: // bottom-left corner of rect
                    _via_canvas.style.cursor = "nesw-resize";
                    break;
                }
            } else {
                var region_id = is_inside_region(_via_current_x, _via_current_y);
                if ( region_id == _via_user_sel_region_id ) {
                    _via_canvas.style.cursor = "move";
                } else {
                    _via_canvas.style.cursor = "default";
                }
            }
        }
    }
    
    if(_via_is_user_drawing_region) {
        // draw rectangle as the user drags the mouse cousor
        _via_redraw_canvas(); // clear old intermediate rectangle

        var region_x0, region_y0;

        if ( _via_click_x0 < _via_current_x ) {
            if ( _via_click_y0 < _via_current_y ) {
                region_x0 = _via_click_x0;
                region_y0 = _via_click_y0;
            } else {
                region_x0 = _via_click_x0;
                region_y0 = _via_current_y;
            }
        } else {
            if ( _via_click_y0 < _via_current_y ) {
                region_x0 = _via_current_x;
                region_y0 = _via_click_y0;
            } else {
                region_x0 = _via_current_x;
                region_y0 = _via_current_y;
            }
        }
        var dx = Math.round(Math.abs(_via_current_x - _via_click_x0));
        var dy = Math.round(Math.abs(_via_current_y - _via_click_y0));

        _via_draw_rect_region(region_x0,
                              region_y0,
                              dx,
                              dy);
        _via_canvas.focus();
    }
    
    if ( _via_is_user_resizing_region ) {
        // user has clicked mouse on bounding box edge and is now moving it
        _via_redraw_canvas(); // clear old intermediate rectangle

        var region_id = _via_region_edge[0];
        var attr = _via_canvas_regions[region_id].shape_attributes;
        var x0 = _via_canvas_regions[region_id].shape_attributes.get('x');
        var y0 = _via_canvas_regions[region_id].shape_attributes.get('y');
        var x1 = x0 + _via_canvas_regions[region_id].shape_attributes.get('width');
        var y1 = y0 + _via_canvas_regions[region_id].shape_attributes.get('height');

        switch(_via_region_edge[1]) {
        case 1: // top-left
            x0 = _via_current_x;
            y0 = _via_current_y;
            break;
        case 3: // bottom-right
            x1 = _via_current_x;
            y1 = _via_current_y;
            break;
        case 2: // top-right
            x1 = _via_current_x;
            y0 = _via_current_y;
            break;
        case 4: // bottom-left
            x0 = _via_current_x;
            y1 = _via_current_y;
            break;
        }
        _via_draw_rect_region(x0,
                              y0,
                              Math.abs(x1-x0),
                              Math.abs(y1-y0),
                              true);
        _via_canvas.focus();
    }

    if ( _via_is_user_moving_region ) {
        _via_redraw_canvas();
        
        var move_x = (_via_current_x - _via_region_click_x);
        var move_y = (_via_current_y - _via_region_click_y);
        var attr = _via_canvas_regions[_via_user_sel_region_id].shape_attributes;

        _via_draw_rect_region(attr.get('x') + move_x,
                              attr.get('y') + move_y,
                              attr.get('width'),
                              attr.get('height'),
                              true);
        _via_canvas.focus();    
    }
});

function toggle_img_list() {
    if (_via_is_loaded_img_list_visible) {
        loaded_img_list_panel.style.width = "0";
        _via_is_loaded_img_list_visible = false;
        return;
    } else {
        _via_is_loaded_img_list_visible = true;
        show_img_list();
    }

}

// @todo: implement hierarchial clustering to better visualize file list
function show_img_list() {
    if (_via_images_count == 0) {
        show_message("Please load some images first!", VIA_THEME_MESSAGE_TIMEOUT_MS);
        return;
    }

    if(_via_is_loaded_img_list_visible) {
        if ( _via_reload_img_table ) {
            reload_img_table();
            _via_reload_img_table = false;
        }

        loaded_img_list_panel.innerHTML = _via_loaded_img_table_html.join('');
        loaded_img_list_panel.style.width = "300px";
    }
}

function reload_img_table() {
    _via_loaded_img_fn_list = [];
    _via_loaded_img_region_attr_miss_count = [];
    
    for (var i=0; i<_via_images_count; ++i) {
        img_id = _via_image_id_list[i];
        _via_loaded_img_fn_list[i] = _via_images[img_id].filename;
        _via_loaded_img_region_attr_miss_count[i] = count_missing_region_attr(img_id);
    }
    
    _via_loaded_img_table_html = [];
    _via_loaded_img_table_html.push('<span class="button"' +
                                    ' style="font-size: 2em; float: right;"' + 
                                    ' onclick="toggle_img_list()">&times</span>');
    _via_loaded_img_table_html.push('<h3>Image List</h3>');
    _via_loaded_img_table_html.push('<ul>');
    for (var i=0; i<_via_images_count; ++i) {
        var fni = '';
        if (i == _via_image_index) {
            // highlight the current entry
            fni += '<li style="cursor: default;">';
            fni += '<b>[' + (i+1) + '] ' + _via_loaded_img_fn_list[i] + '</b>';
        } else {
            fni += '<li onclick="jump_to_image(' + (i) + ')">';
            fni += '[' + (i+1) + '] ' + _via_loaded_img_fn_list[i];
        }

        if (_via_loaded_img_region_attr_miss_count[i]) {
            fni += ' (' + '<span style="color: red;">';
            fni += _via_loaded_img_region_attr_miss_count[i] + '</span>' + ')'
        }
        
        fni += '</li>';
        _via_loaded_img_table_html.push(fni);
    }
    _via_loaded_img_table_html.push('</ul>');
}

function jump_to_image(image_index) {
    if ( image_index >=0 &&
         image_index < _via_images_count) {
        show_image(image_index);
    }
}

function count_missing_region_attr(img_id) {
    var miss_region_attr_count = 0;
    for( var i=0; i<_via_images[img_id].regions.length; ++i) {
        var rattr = _via_images[img_id].regions[i].region_attributes;
        if (rattr.get(VIA_FACE_LABEL_ATTR_NAME) == 'undefined' ||
            rattr.get(VIA_FACE_LABEL_ATTR_NAME) == '' ||
            !rattr.has(VIA_FACE_LABEL_ATTR_NAME)) {
            miss_region_attr_count += 1;
        }
    }
    return miss_region_attr_count;
}

//
// Canvas update routines
//

function _via_redraw_canvas() {
    if (_via_current_image_loaded) {
        _via_ctx.clearRect(0, 0, _via_canvas.width, _via_canvas.height);
        _via_ctx.drawImage(_via_current_image, 0, 0, _via_canvas.width, _via_canvas.height);

        if ( _via_canvas_regions.length > 0 ) {
            draw_all_regions();
            draw_all_region_id();
        }
    }
}

function draw_all_regions() {
    for (var i=0; i < _via_canvas_regions.length; ++i) {
        var attr = _via_canvas_regions[i].shape_attributes;
        var is_selected = _via_canvas_regions[i].is_user_selected;
        
        _via_draw_rect_region(attr.get('x'),
                              attr.get('y'),
                              attr.get('width'),
                              attr.get('height'),
                              is_selected);
    }
}

function _via_draw_rect_region(x, y, w, h, is_selected) {
    if (is_selected) {
        _via_draw_rect(x, y, w, h);
        
        _via_ctx.strokeStyle = VIA_THEME_SEL_REGION_FILL_BOUNDARY_COLOR;
        _via_ctx.lineWidth = VIA_THEME_REGION_BOUNDARY_WIDTH/2;
        _via_ctx.stroke();

        _via_ctx.fillStyle = VIA_THEME_SEL_REGION_FILL_COLOR;
        _via_ctx.globalAlpha = VIA_THEME_SEL_REGION_OPACITY;
        _via_ctx.fill();
        _via_ctx.globalAlpha = 1.0;
    } else {
        // draw a fill line
        _via_ctx.strokeStyle = VIA_THEME_BOUNDARY_FILL_COLOR;
        _via_ctx.lineWidth = VIA_THEME_REGION_BOUNDARY_WIDTH/2;
        _via_draw_rect(x, y, w, h);
        _via_ctx.stroke();

        if ( w > VIA_THEME_REGION_BOUNDARY_WIDTH &&
             h > VIA_THEME_REGION_BOUNDARY_WIDTH ) {
            // draw a boundary line on both sides of the fill line
            _via_ctx.strokeStyle = VIA_THEME_BOUNDARY_LINE_COLOR;
            _via_ctx.lineWidth = VIA_THEME_REGION_BOUNDARY_WIDTH/4;
            _via_draw_rect(x - VIA_THEME_REGION_BOUNDARY_WIDTH/2,
                           y - VIA_THEME_REGION_BOUNDARY_WIDTH/2,
                           w + VIA_THEME_REGION_BOUNDARY_WIDTH,
                           h + VIA_THEME_REGION_BOUNDARY_WIDTH);
            _via_ctx.stroke();

            _via_draw_rect(x + VIA_THEME_REGION_BOUNDARY_WIDTH/2,
                           y + VIA_THEME_REGION_BOUNDARY_WIDTH/2,
                           w - VIA_THEME_REGION_BOUNDARY_WIDTH,
                           h - VIA_THEME_REGION_BOUNDARY_WIDTH);
            _via_ctx.stroke();
        }
    }
}

function _via_draw_rect(x, y, w, h) {
    _via_ctx.beginPath();
    _via_ctx.moveTo(x  , y);
    _via_ctx.lineTo(x+w, y);
    _via_ctx.lineTo(x+w, y+h);
    _via_ctx.lineTo(x  , y+h);
    _via_ctx.closePath();
}

function draw_all_region_id() { 
    _via_ctx.shadowColor = "transparent";
    for (var i=0; i < _via_images[_via_image_id].regions.length; ++i) {
        var rattr = _via_images[_via_image_id].regions[i].region_attributes;
        var annotation_str = '?';
        if (rattr.has(VIA_FACE_LABEL_ATTR_NAME)) {
            annotation_str = rattr.get(VIA_FACE_LABEL_ATTR_NAME);
        }

        var bbox = get_canvas_region_bounding_box(i);

        var x = bbox[0];
        var y = bbox[1];
        var w = Math.abs(bbox[2] - bbox[0]);
        var h = Math.abs(bbox[3] - bbox[1]);
        _via_ctx.font = '8pt Sans';

        var bgnd_rect_height = 1.8 * _via_ctx.measureText('M').width;
        var bgnd_rect_width = _via_ctx.measureText(annotation_str).width;

        if ( bgnd_rect_width > w ) {
            var max_str_len = Math.round(annotation_str.length * (w/bgnd_rect_width)) - 2;
            annotation_str = annotation_str.substring(0, max_str_len) + '.';
            bgnd_rect_width = w;
        } else {
            bgnd_rect_width = bgnd_rect_width + 0.6*bgnd_rect_height;
        }

        // first, draw a background rectangle first
        _via_ctx.fillStyle = 'black';
        _via_ctx.globalAlpha=0.8;
        _via_ctx.fillRect(x,
                          y - bgnd_rect_height,
                          bgnd_rect_width,
                          bgnd_rect_height);
        
        // then, draw text over this background rectangle
        _via_ctx.globalAlpha=1.0;
        _via_ctx.fillStyle = 'yellow';
        _via_ctx.fillText(annotation_str,
                          x+bgnd_rect_height/4,
                          y - bgnd_rect_height/3);

    }
}

function get_canvas_region_bounding_box(region_id) {
    var bbox = new Array(4);
    var d = _via_canvas_regions[region_id].shape_attributes;
    bbox[0] = d.get('x');
    bbox[1] = d.get('y');
    bbox[2] = d.get('x') + d.get('width');
    bbox[3] = d.get('y') + d.get('height');;
    return bbox;
}

//
// Region collision routines
//
function is_inside_region(px, py) {
    for (var i=0; i < _via_canvas_regions.length; ++i) {
        var attr = _via_canvas_regions[i].shape_attributes;
        var result = false;
        
        result = is_inside_rect(attr.get('x'),
                                attr.get('y'),
                                attr.get('width'),
                                attr.get('height'),
                                px, py);

        if (result) {
            return i;
        }
    }    
    return -1;
}

function is_on_region_corner(px, py) {
    // region_id, corner_id [top-left=1,top-right=2,bottom-right=3,bottom-left=4]
    var _via_region_edge = [-1, -1];
    
    for (var i=0; i < _via_canvas_regions.length; ++i) {
        var attr = _via_canvas_regions[i].shape_attributes;
        var result = false;
        _via_region_edge[0] = i;
        
        result = is_on_rect_edge(attr.get('x'),
                                 attr.get('y'),
                                 attr.get('width'),
                                 attr.get('height'),
                                 px, py);

        if (result > 0) {
            _via_region_edge[1] = result;
            return _via_region_edge;
        }
    }
    _via_region_edge[0] = -1;
    return _via_region_edge;
}

function is_on_rect_edge(x, y, w, h, px, py) {
    var dx0 = Math.abs(x - px);
    var dy0 = Math.abs(y - py);
    var dx1 = Math.abs(x + w - px);
    var dy1 = Math.abs(y + h - py);

    //[top-left=1,top-right=2,bottom-right=3,bottom-left=4]
    if ( dx0 < VIA_REGION_EDGE_TOL &&
         dy0 < VIA_REGION_EDGE_TOL ) {
        return 1;
    }
    if ( dx1 < VIA_REGION_EDGE_TOL &&
         dy0 < VIA_REGION_EDGE_TOL ) {
        return 2;
    }
    if ( dx1 < VIA_REGION_EDGE_TOL &&
         dy1 < VIA_REGION_EDGE_TOL ) {
        return 3;
    }

    if ( dx0 < VIA_REGION_EDGE_TOL &&
         dy1 < VIA_REGION_EDGE_TOL ) {
        return 4;
    }
    return 0;
}

function is_inside_rect(x, y, w, h, px, py) {
    if ( px > x &&
         px < (x+w) &&
         py > y &&
         py < (y+h) ) {
        return true;
    } else {
        return false;
    }
}

function update_ui_components() {
    if ( !_via_is_window_resized && _via_current_image_loaded ) {
        show_message("Resizing window ...");
        _via_is_window_resized = true;
        show_image(_via_image_index);
        reset_zoom_level();
    }
}


window.addEventListener("keydown", function(e) {
    // commands invoked by pressing Ctrl + ?
    if ( e.ctrlKey ) {
        switch(e.key) {
        case 's':
            download_all_region_data('csv');
            e.preventDefault();
            break;
        case 'i':
            upload_region_data_file();
            e.preventDefault();
            break;
        case 'o':
            load_images('image');
            e.preventDefault();
            break;
        case 'a':
            toggle_all_regions_selection(true);
            _via_is_all_region_selected = true;
            update_attributes_input_panel();
            _via_redraw_canvas();
            e.preventDefault();
            break;
        case 'c':
            _via_copied_image_regions.splice(0);
            _via_copied_canvas_regions.splice(0);
            for (var i=0; i<_via_images[_via_image_id].regions.length; ++i) {
                var img_region = _via_images[_via_image_id].regions[i];
                var canvas_region = _via_canvas_regions[i];
                if (canvas_region.is_user_selected) {
                    _via_copied_image_regions.push( clone_image_region(img_region) );
                    _via_copied_canvas_regions.push( clone_image_region(canvas_region) );
                }
            }
            show_message('Copied ' + _via_copied_image_regions.length + ' selected regions. ' +
                         'Press Ctrl + v to paste');
            e.preventDefault();
            break;

        case 'v':
            for (var i=0; i<_via_copied_image_regions.length; ++i) {
                _via_images[_via_image_id].regions.push( _via_copied_image_regions[i] );
                _via_canvas_regions.push( _via_copied_canvas_regions[i] );
            }
            show_message('Pasted ' + _via_copied_image_regions.length + ' regions');
            _via_redraw_canvas();
            _via_canvas.focus();
            e.preventDefault();
            break;

        case 'f':
            load_images('face_label');
            e.preventDefault();
            break;
        }
        return;
    }

    // commands invoked by pressing Alt + ?
    if (e.altKey) {
        switch(e.key) {
        case 'd':
            delete_selected_regions();
            update_attributes_input_panel();
            _via_reload_img_table = true;       
            show_img_list();
            _via_redraw_canvas();
            _via_canvas.focus();
            e.preventDefault();
            break;
        }
        return;
    }

    // other commands invoked by pressing a single key
    switch(e.key) {
    case '+': // zoom in
        if (_via_canvas_zoom_level_index == (VIA_CANVAS_ZOOM_LEVELS.length-1)) {
            show_message('Further zoom-in not possible', VIA_THEME_MESSAGE_TIMEOUT_MS);
        } else {
            _via_canvas_zoom_level_index += 1;
            
            _via_is_canvas_zoomed = true;
            var zoom_scale = VIA_CANVAS_ZOOM_LEVELS[_via_canvas_zoom_level_index];
            _via_ctx.scale(zoom_scale, zoom_scale);
            
            _via_canvas.height = _via_canvas_height * zoom_scale;
            _via_canvas.width = _via_canvas_width * zoom_scale;
            _via_canvas_scale = _via_canvas_scale_without_zoom / zoom_scale;

            _via_load_canvas_regions(); // image to canvas space transform
            _via_redraw_canvas();
            _via_canvas.focus();
            show_message('Zoomed in to level ' + zoom_scale, VIA_THEME_MESSAGE_TIMEOUT_MS);
        }
        e.preventDefault();
        break;
    case '-': // zoom out
        if (_via_canvas_zoom_level_index == 0) {
            show_message('Further zoom-out not possible', VIA_THEME_MESSAGE_TIMEOUT_MS);
        } else {
            _via_canvas_zoom_level_index -= 1;
            
            _via_is_canvas_zoomed = true;
            var zoom_scale = VIA_CANVAS_ZOOM_LEVELS[_via_canvas_zoom_level_index];
            _via_ctx.scale(zoom_scale, zoom_scale);
            
            _via_canvas.height = _via_canvas_height * zoom_scale;
            _via_canvas.width = _via_canvas_width * zoom_scale;
            _via_canvas_scale = _via_canvas_scale_without_zoom / zoom_scale;

            _via_load_canvas_regions(); // image to canvas space transform
            _via_redraw_canvas();
            _via_canvas.focus();
            show_message('Zoomed out to level ' + zoom_scale, VIA_THEME_MESSAGE_TIMEOUT_MS);
        }
        e.preventDefault();
        break;
    case '0': // reset the zoom level
        reset_zoom_level();
        show_message('Zoom reset', VIA_THEME_MESSAGE_TIMEOUT_MS);
        e.preventDefault();
        break;
    case "n":
    case 'ArrowRight':
        move_to_next_image();
        e.preventDefault();
        break;
    case 'p':
    case 'ArrowLeft':
        move_to_prev_image();
        e.preventDefault();
        break;
    case 'Backspace':
    case 'Delete':
        delete_selected_regions();
        update_attributes_input_panel();
        _via_reload_img_table = true;       
        show_img_list();
        _via_redraw_canvas();
        _via_canvas.focus();
        e.preventDefault();
        break;
    case 'a':
        toggle_attributes_input_panel();
        e.preventDefault();
        break;

    case 'l':
        toggle_img_list();
        e.preventDefault();
        break;
    case 'Escape':
        if (_via_is_all_region_selected) {
            toggle_all_regions_selection(false);
        }
        if ( _via_is_region_selected ) {
            _via_is_region_selected = false;
            _via_canvas_regions[_via_user_sel_region_id].is_user_selected = false;
            _via_user_sel_region_id = -1;
        }
        _via_is_user_drawing_region = false;
        _via_is_user_resizing_region = false;
        _via_is_user_moving_region = false;
        e.preventDefault();
        _via_redraw_canvas();
        _via_canvas.focus();
        break;
    case 'F1':
        show_getting_started_panel();
        e.preventDefault();
        break;
    }
});

function move_to_prev_image() {
    if (_via_images_count > 0) {
        _via_canvas.style.cursor = "default";
        if ( _via_image_index == 0 ) {   
            show_image(_via_images_count - 1);
        } else {
            show_image(_via_image_index - 1);
        }
    }    
}

function move_to_next_image() {
    if (_via_images_count > 0) {
               
        if ( _via_image_index == (_via_images_count-1) ) {   
            show_image(0);
        } else {
            show_image(_via_image_index + 1);
        }
    }
}

function reset_zoom_level() {
    _via_is_canvas_zoomed = false;
    _via_canvas_zoom_level_index = VIA_CANVAS_DEFAULT_ZOOM_LEVEL_INDEX
    var zoom_scale = VIA_CANVAS_ZOOM_LEVELS[_via_canvas_zoom_level_index];
    _via_ctx.scale(zoom_scale, zoom_scale);
    
    _via_canvas.height = _via_canvas_height;
    _via_canvas.width = _via_canvas_width;
    _via_canvas_scale = _via_canvas_scale_without_zoom;
    
    _via_load_canvas_regions(); // image to canvas space transform
    _via_redraw_canvas();
    _via_canvas.focus();
}

//
// Update of user interface elements
// Communication from javascript to UI
//
function show_message(msg, t) {
    if ( _via_message_clear_timer ) {
        clearTimeout(_via_message_clear_timer); // stop any previous timeouts
    }
    var timeout = t;
    if (typeof t === 'undefined') {
        timeout = VIA_THEME_MESSAGE_TIMEOUT_MS;
    }
    document.getElementById('message_panel').innerHTML = msg;
    _via_message_clear_timer = setTimeout( function() {
        document.getElementById('message_panel').innerHTML = ' ';
    }, timeout);
}

function show_filename_info() {
    if ( _via_current_image_loaded ) {
        document.getElementById("info_current_filename").innerHTML = _via_current_image_filename;
        var fid_info = "(" + (_via_image_index+1) + " of " + _via_images_count + ")";
        document.getElementById("info_current_fileid").innerHTML = fid_info;
    } else {
        document.getElementById("info_current_filename").innerHTML = "";
        document.getElementById("info_current_fileid").innerHTML = "";
    }
}

//
// Persistence of annotation data in localStorage
//

function check_local_storage() {
    // https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API/Using_the_Web_Storage_API
    try {
        var x = '__storage_test__';
        localStorage.setItem(x, x);
        localStorage.removeItem(x);
        return true;
    }
    catch(e) {
        return false;
    }
}

function save_current_data_to_browser_cache() {
    setTimeout(function() {
        if ( _via_is_local_storage_available &&
             ! _via_is_save_ongoing) {
            try {
                _via_is_save_ongoing = true;
                localStorage.setItem('_via_timestamp', Date.now());
                localStorage.setItem('_via_images', package_region_data('json'));

                // save attributes
                var attr = [];
                for (var attribute of _via_region_attributes) {
                    attr.push(attribute);
                }
                localStorage.setItem('_via_region_attributes', JSON.stringify(attr));
                _via_is_save_ongoing = false;
            } catch(err) {
                _via_is_save_ongoing = false;
                _via_is_local_storage_available = false;
                show_message('Failed to save data to browser cache. Please download the annotation data.');
                alert('Failed to save data to browser cache. Please download the annotation data.');
                console.log('Failed to save data to browser cache');
                console.log(err.message);
            }
        }
    }, 1000);
}

function is_via_data_in_localStorage() {
    if (localStorage.getItem('_via_timestamp')) {
        return true;
    } else {
        return false;
    }
}

function clear_localStorage() {
    document.getElementById('localStorage_recovery_msg').innerHTML = '';
    localStorage.clear();
    show_home_panel();
}

function show_localStorage_recovery_options() {
    var hstr = [];
    var date_of_saved_data = new Date( parseInt(localStorage.getItem('_via_timestamp')) );
    
    hstr.push('<div style="margin-top: 4em; padding: 1em; border: 1px solid #cccccc;">');
    hstr.push('<h3 style="border-bottom: 1px solid #5599FF">' +
              'Data Recovery from Browser Cache</h3>');
    hstr.push('<ul><li>Data saved on : ' + date_of_saved_data);
    hstr.push('<br/><span class="action_text_link" ' +
              'onclick="download_localStorage_data(\'csv\')" ' +
              'title="Recover annotation data">[Save as CSV]</span>');
    hstr.push(' | ');
    hstr.push('<span class="action_text_link" ' +
              'onclick="download_localStorage_data(\'json\')" ' +
              'title="Recover annotation data">[Save as JSON]</span>');
    hstr.push(' | ');
    hstr.push('<span class="action_text_link" ' +
              'onclick="clear_localStorage()" ' +
              'title="Discard annotation data">[Discard Data]</span>');
    hstr.push('</li></ul>');
    hstr.push('<p><b>If you continue, the cached data will be discarded!</b></p></div>');
    
    document.getElementById('localStorage_recovery_msg').innerHTML = hstr.join('');
}

function download_localStorage_data(type) {
    switch(type) {
    case 'csv':
        var d = JSON.parse( localStorage.getItem('_via_images') );
        var csvdata = [];
        var csvheader = '#filename,file_size,face_count,face_id,x,y,width,height,';
        csvdata.push(csvheader);

        for (var image_id in d) {
            var prefix = d[image_id].filename;
            prefix += "," + d[image_id].size;

            // copy regions
            var regions = d[image_id].regions;
            var region_count = 0;
            for (var i in regions) {
                region_count += 1;
            }

            if (region_count !=0) {
                for (var i=0; i<region_count; ++i) {
                    var sdata = regions.length + ',' + i + ',';
                    sdata += regions[i].shape_attributes['x'] + ',';
                    sdata += regions[i].shape_attributes['y'] + ',';
                    sdata += regions[i].shape_attributes['width'] + ',';
                    sdata += regions[i].shape_attributes['height'];

                    var rdata = regions[i].region_attributes[VIA_FACE_LABEL_ATTR_NAME];
                    
                    csvdata.push('\n' + prefix + ',' + sdata + ',' + '"' + rdata + '"');
                }
            }
        }
        var localStorage_data_blob = new Blob( csvdata,
                                               {type: 'text/csv;charset=utf-8'});

        save_data_to_local_file(localStorage_data_blob, 'via_region_data.csv');
        break;
    case 'json':
        var localStorage_data_blob = new Blob( [localStorage.getItem('_via_images')],
                                               {type: 'text/json;charset=utf-8'});
        save_data_to_local_file(localStorage_data_blob, 'via_region_data.json');
        break;
    }
    
}

//
// Handlers for attributes input panel (spreadsheet like user input panel)
//
function toggle_attributes_input_panel() {
    if (_via_is_attributes_input_panel_visible) {
        hide_attributes_input_panel();
    } else {
        show_attributes_input_panel();
    }
}
function hide_attributes_input_panel() {
    attributes_input_panel.style.display = 'none';
    _via_is_attributes_input_panel_visible = false;

}
function show_attributes_input_panel() {
    _via_is_attributes_input_panel_visible = true;
    update_attributes_input_panel();
    attributes_input_panel.style.display = 'block';
}

function update_attributes_input_panel() {
    if (_via_face_label_list.length == 0) {
        var htmlmsg = '<div style="margin: auto; text-align: center; width: 40%;padding: 2em 0;">' +
            'Import a list of representative face images using ' +
            '[<span class="js_button" title="Load face label images" ' +
            'onclick="load_images(\'face_label\')">Import Face Labels</span>]. ' +
            'Representative images correspond to facial image of individuals that ' +
            'you wish to locate and  annotate in several images.</div>';
        face_label_panel.innerHTML = htmlmsg;
        return;
    }
    
    if (_via_is_attributes_input_panel_visible) {
        var face_label_html = [];
        var selregion_id = -1;
        if ( _via_current_image_loaded &&
             _via_is_region_selected) {
            var selregion = _via_images[_via_image_id].regions[_via_user_sel_region_id].region_attributes;
            if (selregion.has(VIA_FACE_LABEL_ATTR_NAME)) {
                var selregion_label = selregion.get(VIA_FACE_LABEL_ATTR_NAME);
                selregion_id = _via_face_label_list.indexOf(selregion_label);
            }
        }    

        var fl_height = _via_face_label_height_list[_via_face_label_height_id];
        for (var i=0; i<_via_face_label_list.length; ++i) {
            if ( typeof(_via_face_label_list[i]) !== 'undefined' &&
                 typeof(_via_face_label_img_list[i]) !== 'undefined') {
                var fid = 'fl' + i;
                if ( selregion_id == i) {
                    // if this element is hidden, auto-scroll to show this element
                    face_label_html.push('<div id="' + fid + '"' + 
                                         ' class="active_face_label selected">');
                } else {
                    if (_via_is_region_selected) {
                        face_label_html.push('<div id="' + fid + '" class="active_face_label">');
                    } else {
                        face_label_html.push('<div id="' + fid + '" class="face_label">');
                    }
                }
                face_label_html.push(_via_face_label_list[i] + '<br/>');
                face_label_html.push('<img title="' + _via_face_label_list[i] + '"');
                face_label_html.push(' src="' + _via_face_label_img_list[i] + '"');
                face_label_html.push(' height="' + fl_height + 'px"');
                if (_via_is_region_selected) {
                    face_label_html.push(' onclick="set_face_label(\'' + _via_face_label_list[i] + '\')"');
                }
                face_label_html.push(' alt="' + _via_face_label_list[i] + '" />');
                //face_label_html.push('<br/>' + _via_face_label_list[i].split(' ').join('<br/>'));
                face_label_html.push('</div>');
            }
        }
        face_label_panel.innerHTML = face_label_html.join('');

        // move the scrollbar automatically show that selected label is visible
        if (selregion_id != -1) {
            var sel_label = document.getElementById('fl' + selregion_id);
            var panelwidth = attributes_input_panel.offsetWidth;
            var seloffset = sel_label.offsetLeft;
            
            if (seloffset > panelwidth ) {
                attributes_input_panel.scrollLeft = sel_label.offsetLeft - panelwidth/2;
            } else {
                attributes_input_panel.scrollLeft = '0';
            }
        }
    }
}

function set_face_label(value) {
    if (_via_is_region_selected) {
        var selregion = _via_images[_via_image_id].regions[_via_user_sel_region_id];
        selregion.region_attributes.set(VIA_FACE_LABEL_ATTR_NAME, value);

        // find out if any other region attribute is missing
        for (var i=0; i<_via_canvas_regions.length; ++i) {
            var r = _via_images[_via_image_id].regions[i];
            if (r.region_attributes.get(VIA_FACE_LABEL_ATTR_NAME) == 'undefined' ||
                typeof(r.region_attributes.get(VIA_FACE_LABEL_ATTR_NAME)) == 'undefined') {
                _via_canvas_regions[_via_user_sel_region_id].is_user_selected = false;
                _via_user_sel_region_id = i;
                _via_canvas_regions[i].is_user_selected = true;
                break;
            }
        }
                
        update_attributes_input_panel();
        _via_reload_img_table = true;   
        show_img_list();
        _via_redraw_canvas();
        _via_canvas.focus();
    }
}

function set_attr_panel_height(label_height) {
    if (label_height >= 80 && label_height <140) {
        document.getElementById('attributes_input_panel').style.height = '120px';
    }
    if (label_height >= 140 && label_height <=200) {
        document.getElementById('attributes_input_panel').style.height = '180px';
    }
    if (label_height > 200) {
        document.getElementById('attributes_input_panel').style.height = '300px';
    }
}

function increase_face_label_height() {
    if (_via_face_label_height_id < (_via_face_label_height_list.length-1)) {
        _via_face_label_height_id += 1;
        var label_height = _via_face_label_height_list[_via_face_label_height_id];
        set_attr_panel_height(label_height);
        update_attributes_input_panel();
    } else {
        show_message('Face labels cannot be zoomed-in any further!', 1000);
    }
}

function decrease_face_label_height() {
    if (_via_face_label_height_id > 0) {
        _via_face_label_height_id -= 1;
        var label_height = _via_face_label_height_list[_via_face_label_height_id];
        set_attr_panel_height(label_height);
        update_attributes_input_panel();
    } else {
        show_message('Face labels cannot be zoomed-out any further!', 1000);
    }
}

function reset_face_label_height() {
    _via_face_label_height = VIA_FACE_LABEL_DEFAULT_HEIGHT_ID;
    update_attributes_input_panel();
}

    </script>
  </body>
</html>
